# CLAUDE.md

This file provides comprehensive guidance for Claude Code when working with the Piesson GitHub Profile Dashboard project.

## 🚨 CRITICAL RULES

### Git Commit Guidelines
- **NEVER use emojis in commit messages**
- Use clear, descriptive commit messages in English
- Follow conventional commit format: `type: description`
- Types: `feat`, `fix`, `refactor`, `chore`, `style`, `docs`

## 🎯 Project Overview

**Piesson GitHub Profile Dashboard** - Automated system displaying GitHub stats and weekly grind metrics on GitHub profile README.

### Two Main Systems:
1. **GitHub Profile Cards** - Shows commit stats, contributions, activity distribution
2. **Weekly Dashboard** - Tracks startup grind metrics (commits, user talks, social posts, etc.)

## 📁 Complete File Structure

```
Piesson/
├── dashboard/
│   ├── data.json                      # Current week metrics + 12-week history
│   ├── generate_svg.py                # Generates current week dashboard SVG (520x330px)
│   ├── generate_profile_card.py       # Generates custom 4-quadrant profile card (500x220px)
│   ├── graphql_stats.py              # GitHub GraphQL API integration (2020-2025 data)
│   ├── generate_slack_message.py      # Daily Slack reminder generator (7 AM/7 PM KST)
│   ├── slack_update.py               # Processes Slack input, updates data.json (additive)
│   ├── update_data.py                # Legacy manual data update script (not used)
│   ├── check_daily_update.py         # Checks if daily update received (exit 0=send, 1=skip)
│   ├── check_weekly_reset.py         # Monday reset: saves history, resets metrics (exit 0=reset, 1=skip)
│   ├── generate_weekly_history.py    # Generates individual history SVGs per week
│   ├── generate_weekly_summary.py    # Generates Monday Slack summary message
│   ├── generate_progress_chart.py    # Generates Image-Charts URLs (cumulative progress)
│   ├── update_readme_charts.py       # Updates README with progress chart URLs
│   ├── update_readme_history.py      # Updates README with history table + charts
│   ├── weekly_dashboard.svg          # Current week dashboard SVG (auto-generated)
│   ├── history/
│   │   ├── weekly_history_2025-W42.svg  # Archived week 42 (Oct 13-19)
│   │   ├── weekly_history_2025-W43.svg  # Archived week 43 (Oct 20-26)
│   │   └── weekly_history_2025-W44.svg  # Archived week 44 (Oct 27-Nov 2)
│   ├── profile-summary-card-output/
│   │   └── default/
│   │       └── 0-profile-details.svg    # Duplicate copy (not used in README)
│   ├── README.md                      # Dashboard documentation
│   └── SLACK_SETUP.md                # Slack webhook setup guide
│
├── profile-summary-card-output/
│   ├── default/                       # Default theme (used in README)
│   │   ├── 0-profile-details.svg     # Custom 4-quadrant card (500x220px) ← USED
│   │   ├── 1-repos-per-language.svg  # Generated by vn7n24fzkq action
│   │   ├── 2-most-commit-language.svg
│   │   ├── 3-stats.svg
│   │   └── 4-productive-time.svg
│   ├── 2077/                          # 65 additional theme directories (auto-generated)
│   ├── algolia/                       # All contain identical 5 SVG files
│   ├── ... (60+ more theme folders)   # Generated by vn7n24fzkq action
│   └── README.md                      # Theme documentation
│
├── .github/workflows/
│   ├── profile-summary-cards.yml     # Hourly (cron: 0 * * * *): GitHub profile cards
│   ├── update_dashboard.yml          # Multi-schedule: reminders (7 AM/7 PM KST) + weekly reset (Mon 7 AM KST)
│   └── slack_response.yml            # Manual workflow_dispatch: Slack input processing
│
└── README.md                         # Main profile: dashboard + history table + charts + tech stack
```

## 🔄 System 1: GitHub Profile Cards

### Workflow: `profile-summary-cards.yml`
**Trigger**: Every hour (`0 * * * *`) + manual dispatch
**Runs on**: ubuntu-latest
**Permissions**: contents: write

**Process Flow**:
```
1. GitHub Actions runs hourly
   ↓
2. vn7n24fzkq/github-profile-summary-cards@release
   - Fetches accurate GitHub contribution data
   - Generates 5 standard SVG cards × 65 themes = 325 SVG files
   - Themes: default, 2077, algolia, aura, dracula, nord, etc.
   - Includes private repos with SUMMARY_CARDS_TOKEN
   - UTC_OFFSET: 9 (KST timezone)
   ↓
3. generate_profile_card.py (custom Python script)
   - Calls graphql_stats.py to fetch 2020-2025 data
   - Generates custom 4-quadrant pie chart (144×144px, radius 54px)
   - Current data: Commits (1,476), Reviews (23), PRs (12), Issues (8)
   - Percentages: ~97% commits, ~2% reviews, ~1% PRs, ~1% issues
   - Displays: Total commits (1,476), Join date (Jan 2025), Daily avg (calculated from join date)
   - Output: profile-summary-card-output/default/0-profile-details.svg
   ↓
4. Git commit + push to main branch
   - Only commits if files changed (git diff --staged --quiet)
   - Commit message: "update: automated profile cards generation (original + custom 4-quadrant)"
   - Pushes to main branch
```

### Technical Details

#### GraphQL API Integration (`graphql_stats.py`)
- **Multi-year fetching**: Loops through 2020-2025 (6 years)
  - 2020: Jan 1 00:00:00 → Dec 31 23:59:59 UTC
  - 2021: Jan 1 00:00:00 → Dec 31 23:59:59 UTC
  - 2022: Jan 1 00:00:00 → Dec 31 23:59:59 UTC
  - 2023: Jan 1 00:00:00 → Dec 31 23:59:59 UTC
  - 2024: Jan 1 00:00:00 → Dec 31 23:59:59 UTC
  - 2025: Jan 1 00:00:00 → Dec 31 23:59:59 UTC (current year)
- **Query per year**: `contributionsCollection(from: DateTime!, to: DateTime!)`
- **Data retrieved and aggregated**:
  - `totalCommitContributions` → all_stats['commits']
  - `totalPullRequestReviewContributions` → all_stats['code_reviews']
  - `totalPullRequestContributions` → all_stats['pull_requests']
  - `totalIssueContributions` → all_stats['issues']
- **Accumulation logic**: `all_stats[key] += contributions[key]` (6 years summed)
- **Requires**: `SUMMARY_CARDS_TOKEN` (GitHub PAT with repo scope) for private repos
- **Fallback**: Returns None if token missing or API fails

#### Pie Chart Generation (`generate_profile_card.py`)
- **Pie chart dimensions**: 144×144px (viewBox="0 0 144 144")
- **Radius**: 54px (center point: 72, 72)
- **Position hierarchy**:
  - Main container: `translate(15, 55)` (starts at y=55 below title)
  - Pie chart: `translate(20, 20)` (nested inside main container)
  - Legend: `translate(180, 42)` (vertically centered with pie chart)
- **Colors** (fixed mapping):
  - Commits: `#3b82f6` (Tailwind blue-500)
  - Code Reviews: `#10b981` (Tailwind green-500)
  - Pull Requests: `#f59e0b` (Tailwind amber-500)
  - Issues: `#ef4444` (Tailwind red-500)
- **Slice rendering**:
  - Start angle: -90° (top of circle, 12 o'clock position)
  - Arc calculation: `(value / total) × 360°`
  - Path command: `M center,center L x1,y1 A radius,radius 0 large_arc,1 x2,y2 Z`
  - Label position: 70% of radius from center (radius × 0.7)
  - Label font: 12px bold white text with percentage (e.g., "97%")
- **Data synchronization**: Single `get_github_activity_stats()` call, used by:
  1. Pie chart percentages
  2. Legend with absolute values
  3. Right-side "Total Commits" display
- **Join date logic**:
  - Hardcoded: `datetime(2025, 1, 1)` (Jan 1, 2025)
  - **CRITICAL BUG**: Code has TWO different join dates!
    - Line 18: `datetime(2024, 8, 1)` (Aug 2024) in `get_github_data_from_stats()`
    - Line 62: `datetime(2025, 1, 1)` (Jan 2025) in `get_github_data()` ← ACTUALLY USED
  - Daily avg calculation: `total_commits / days_since_join` (rounded to 1 decimal)
  - Display format: "Jan 2025" (not Aug 2024)

#### Layout Optimization
- **Card dimensions**: 500x220px
- **Vertical centering**: Pie chart centered with 4-item legend (80px total height)
- **Spacing**:
  - Main container: `translate(15, 55)`
  - Pie chart: Left-aligned for better visual balance
  - Divider: `x1="350"` separates left (chart+legend) from right (stats)

## 🔄 System 2: Weekly Dashboard

### Workflow: `update_dashboard.yml`
**Runs on**: ubuntu-latest
**Permissions**: contents: write
**Two Jobs**: `daily-reminder` (schedule/workflow_dispatch) + `update-dashboard` (push)

#### Job 1: `daily-reminder` (Schedule-based)
**Triggers**:
- **Monday 7 AM KST**: `cron: '0 22 * * 1'` (10 PM UTC Sunday) → Weekly reset only
- **Tue-Sun 7 AM KST**: `cron: '0 22 * * 2,3,4,5,6,0'` (10 PM UTC Mon-Sat) → Morning reminder
- **Every day 7 PM KST**: `cron: '0 10 * * *'` (10 AM UTC) → Evening reminder
- **Manual trigger**: `workflow_dispatch`

**Process Flow**:
```
1. GitHub Actions runs at scheduled time (3 separate cron triggers)
   ↓
2. check_weekly_reset.py (ALWAYS runs first)
   - Get current week Monday: `today - timedelta(days=today.weekday())`
   - Compare with stored `data.json → currentWeek.startDate`
   - If new week detected:
     a. Save last week to weeklyHistory (insert at index 0)
     b. Reset all metrics to 0 (except commits from git)
     c. Update startDate/endDate to new week
     d. Save data.json
     e. Exit code 0 (reset happened)
   - If same week:
     e. Exit code 1 (no reset)
   ↓
3. If weekly reset happened (exit code 0):
   a. generate_weekly_history.py
      - Generate SVG for each week in weeklyHistory
      - Skip if SVG already exists (idempotent)
      - Output: dashboard/history/weekly_history_2025-W43.svg
   b. update_readme_history.py
      - Update README with history table (last 12 weeks)
      - Update cumulative progress chart URLs (Image-Charts)
   c. update_readme_charts.py
      - Update README with individual metric charts
   d. Git commit + push:
      - Files: dashboard/data.json, dashboard/history/, README.md
      - Message: "Weekly reset: save history and reset metrics"
   e. generate_weekly_summary.py
      - Generate Monday summary Slack message
      - Shows last week's totals and daily averages
      - POST to SLACK_WEBHOOK_URL
   ↓
4. Check if reminder needed
   - If Monday 7 AM KST (CURRENT_HOUR=22, DAY_OF_WEEK=1):
     → Skip reminder (weekly reset already sent summary)
     → Set send_reminder=1 (skip next step)
   - Otherwise:
     → Run check_daily_update.py
     → Reads data.json → lastUpdated field (YYYY-MM-DD format, KST timezone)
     → Compare with today's date (KST timezone)
     → Exit code 0 = send reminder (no update today)
     → Exit code 1 = skip reminder (already updated today)
   ↓
5. If reminder needed (send_reminder=0):
   a. Detect time:
      - CURRENT_HOUR=22 (UTC) → 7 AM KST → MESSAGE_TYPE="morning"
      - CURRENT_HOUR=10 (UTC) → 7 PM KST → MESSAGE_TYPE="evening"
   b. generate_slack_message.py
      - Loads current metrics from data.json
      - Counts commits: GitHub GraphQL API (all repos, private included)
      - Generates formatted Slack message JSON
      - Morning: ":fire:" emoji, "⏰ Time to grind", "Let's ship it! 🚀"
      - Evening: ":rotating_light:" emoji, "🚨 GRIND CHECK: Still 0 today?", "Time to lock in! 💪"
   c. curl POST to SLACK_WEBHOOK_URL
      - Sends rich formatted message with current week totals
      - Shows breakdown: commits, user talks, social (IG/TT/HT), coffee chats, workouts (Run/Gym), blog posts
      - Includes input format: `1 0 0 2 0 0 1 1`
      - Order: Instagram, TikTok, HelloTalk, UserTalks, CoffeeChats, BlogPosts, Running, Gym
```

#### Job 2: `update-dashboard` (Push-based)
**Trigger**: Push event with path filter: `dashboard/data.json`
**Condition**: `if: github.event_name == 'push'`

**Process Flow**:
```
1. Slack input processed → data.json updated (by slack_update.py or slack_response.yml)
   ↓
2. GitHub Actions detects push to dashboard/data.json
   ↓
3. generate_svg.py
   - Step 1: Auto-calculate commits from GitHub GraphQL API
     → Calls get_weekly_commits() → queries GitHub API for current week
     → Gets commits from ALL repositories (private + public)
     → Overwrites data.json → currentWeek.metrics.commits
     → Saves data.json (commit count auto-updated)
   - Step 2: Load metrics from data.json
     → currentWeek.metrics (with auto-updated commits)
   - Step 3: Calculate current week dates (Monday-Sunday, KST timezone)
     → today = datetime.now(KST)
     → monday = today - timedelta(days=today.weekday())
     → sunday = monday + timedelta(days=6)
     → Format: MM/DD/YYYY (US format)
   - Step 4: Generate 520×330px SVG
     → Background: linear gradient #ffffff → #f8fafc
     → Title: "Moved the needle this week? 📈" (y=35)
     → Subtitle: "10/27/2025 — 11/02/2025" (y=60)
     → 6 metric cards (120×100px each) in 3×2 grid:
       Row 1 (y=85): Commits (x=60), User Talks (x=200), Social Posts (x=340)
       Row 2 (y=200): Coffee Chats (x=60), Workouts (x=200), Blog Posts (x=340)
   ↓
4. update_readme_history.py
   - Update README with history table (last 12 weeks)
   - Update cumulative progress chart URLs
   ↓
5. update_readme_charts.py
   - Update README with individual metric charts
   ↓
6. Git commit + push
   - Files: dashboard/data.json, dashboard/weekly_dashboard.svg, README.md
   - Only commits if files changed (git diff --staged --quiet)
   - Message: "update: automated dashboard generation"
   - Pushes to main branch
```

### Slack Integration

#### Input Workflow (`slack_update.py`)
**Triggered by**: `slack_response.yml` (manual workflow_dispatch)
**Workflow inputs**: `metrics` (string, required)

**Process Flow**:
```
1. User types in Slack: "1 0 0 2 0 0 1 1"
   ↓
2. Slack workflow triggers GitHub Actions
   - workflow_dispatch with input: metrics="1 0 0 2 0 0 1 1"
   - Passes via: echo "${{ github.event.inputs.metrics }}" | python3 dashboard/slack_update.py
   ↓
3. slack_update.py receives input via stdin
   - parse_metrics(text) function:
     → Extracts numbers with regex: re.findall(r'\d+', text.strip())
     → Primary format (8 numbers): "1 0 0 2 0 0 1 1"
       Order: Instagram, TikTok, HelloTalk, UserTalks, CoffeeChats, BlogPosts, Running, Gym
     → Fallback format (7 numbers): "3 2 1 10 2 1 5"
       Splits workouts: running = numbers[6] // 2, gym = remainder
     → Fallback format (6 numbers): "5 10 2 1 3 2"
       Splits social: IG/TT/HT = total_social // 3 each
     → Named format: "Instagram: 3, TikTok: 2, ..." (case-insensitive)
   - update_data(metrics) function:
     → Loads data.json
     → **ADDITIVE APPROACH** (critical):
       current_social['instagram'] + metrics['instagram']
       current_social['tiktok'] + metrics['tiktok']
       current_social['hellotalk'] + metrics['hellotalk']
       current['userSessions'] + metrics['usertalks']
       current['ctoMeetings'] + metrics['coffeechats']
       current['blogPosts'] + metrics['blogposts']
       current_workouts['running'] + metrics['running']
       current_workouts['gym'] + metrics['gym']
     → Updates lastUpdated: datetime.now(KST).strftime("%Y-%m-%d")
     → Saves data.json
     → Returns: {'added': metrics, 'totals': {new_totals}}
   ↓
4. send_confirmation_message(webhook_url, result)
   - Generates formatted Slack message:
     → "✅ Well done! Progress updated successfully!"
     → "🔄 ADDED TODAY:" (shows +X for each metric)
     → "📊 NEW TOTALS:" (shows cumulative totals)
   - POST to SLACK_WEBHOOK_URL
   - Username: "GrindBot", Icon: ":white_check_mark:"
   ↓
5. Triggers update-dashboard job (via push to data.json)
   - Push event detected by update_dashboard.yml
   - Runs generate_svg.py → updates weekly_dashboard.svg
   - Auto-commits with message: "update: automated dashboard generation"
```

#### Input Format Evolution (Backward Compatible)
1. **Current (8 numbers)**: `1 0 0 2 0 0 1 1`
   - Order: Instagram, TikTok, HelloTalk, UserTalks, CoffeeChats, BlogPosts, Running, Gym
   - Detection: `len(numbers) >= 8`
   - Mapping: Direct 1:1 mapping (no splitting)
2. **Fallback (7 numbers)**: `3 2 1 10 2 1 5`
   - Order: Instagram, TikTok, HelloTalk, UserTalks, CoffeeChats, BlogPosts, Workouts
   - Detection: `len(numbers) >= 7`
   - Workout split: running = numbers[6] // 2, gym = numbers[6] - running
   - Example: 5 workouts → 2 running, 3 gym
3. **Legacy (6 numbers)**: `5 10 2 1 3 2`
   - Order: Social, UserTalks, CoffeeChats, BlogPosts, Running, Gym
   - Detection: `len(numbers) >= 6`
   - Social split: IG = total // 3, TT = total // 3, HT = total - (IG + TT)
   - Example: 5 social → 1 IG, 1 TT, 3 HT
4. **Named format**: `Instagram: 3, TikTok: 2, HelloTalk: 1, ...`
   - Detection: Regex patterns (case-insensitive)
   - Pattern: r'instagram:\s*(\d+)', r'tiktok:\s*(\d+)', etc.
   - Defaults to 0 if not found

### Dashboard SVG Generation

#### Dimensions & Layout (`generate_svg.py`)
- **Canvas**: 520×330px
  - Width: 520px (60px left margin + 3 cards × 120px + 2 gaps × 20px + 60px right margin)
  - Height: 330px (85px top + 100px row1 + 15px gap + 100px row2 + 30px bottom)
  - **Critical**: Height reduced from 440px to 330px to minimize bottom padding
- **Background**: Linear gradient `#ffffff` → `#f8fafc`
  - Gradient direction: top-left (0%, 0%) to bottom-right (100%, 100%)
- **Border**: 16px border radius with `#e2e8f0` stroke (1px width)
- **Title section**:
  - Title: "Moved the needle this week? 📈" at `y=35`
    - Font: 22px, weight 700, color #0f172a
  - Subtitle: "10/27/2025 — 11/02/2025" at `y=60`
    - Font: 12px, color #64748b
    - Format: MM/DD/YYYY — MM/DD/YYYY (US format, KST timezone)
- **Grid layout** (3×2 grid of cards):
  - **Row 1** (`y=85`):
    - Card 1 (Commits): `translate(60, 85)` → x=60, y=85
    - Card 2 (User Talks): `translate(200, 85)` → x=200, y=85
    - Card 3 (Social Posts): `translate(340, 85)` → x=340, y=85
    - Horizontal spacing: 140px between card centers (60 → 200 → 340)
  - **Row 2** (`y=200`):
    - Card 4 (Coffee Chats): `translate(60, 200)` → x=60, y=200
    - Card 5 (Workouts): `translate(200, 200)` → x=200, y=200
    - Card 6 (Blog Posts): `translate(340, 200)` → x=340, y=200
    - Vertical spacing: 115px between row tops (85 → 200)
  - **Card dimensions**: 120×100px with 12px border radius
    - Background: Linear gradient `#ffffff` → `#f1f5f9`
    - Shadow: feDropShadow (dx=0, dy=2, blur=8px, opacity=0.1)
    - Border: 1px `#e2e8f0` stroke

#### Metric Cards (6 total)
Each card has 3 text elements:
1. **Main number** (y=40): 36px font, weight 800, color #000000
2. **Label** (y=60): 10px font, weight 700, color #1f2937, with emoji
3. **Subtitle** (y=78): 8px font, weight 400, color #9ca3af

**Card 1: Code Commits** (🚀) at translate(60, 85)
- Source: **Auto-calculated from GitHub GraphQL API** (NOT from data.json)
- Method: `get_weekly_commits()` → GitHub API query for current week
- Scope: ALL repositories (private + public)
- Time range: Monday 00:00:00 KST → now
- Current value: 120 commits (as of Oct 28, 2025)
- Data flow: GitHub API → generate_svg.py → data.json (overwrites) → SVG
- Subtitle: "Daily goal: 20 commits"

**Card 2: User Talks** (💬) at translate(200, 85)
- Source: `data.json → currentWeek.metrics.userSessions`
- Example value: 15 talks
- Subtitle: "Daily goal: 1 talk"

**Card 3: Social Posts** (📱) at translate(340, 85)
- Source: Sum of 3 values from data.json:
  - `currentWeek.metrics.socialContent.instagram`
  - `currentWeek.metrics.socialContent.tiktok`
  - `currentWeek.metrics.socialContent.hellotalk`
- Example values: 5 + 3 + 1 = 9 total
- Subtitle: "IG:5 TT:3 HT:1" (breakdown)

**Card 4: Coffee Chats** (☕) at translate(60, 200)
- Source: `data.json → currentWeek.metrics.ctoMeetings`
- Example value: 2 chats
- Subtitle: "Weekly goal: 2 chats"

**Card 5: Workouts** (🏃) at translate(200, 200)
- Source: Sum of 2 values from data.json:
  - `currentWeek.metrics.workouts.running`
  - `currentWeek.metrics.workouts.gym`
- Example values: 3 + 6 = 9 total
- Subtitle: "Run:3 Gym:6" (breakdown)

**Card 6: Blog Posts** (📝) at translate(340, 200)
- Source: `data.json → currentWeek.metrics.blogPosts`
- Example value: 1 post
- Subtitle: "AI & Startup content"

#### Week Calculation (KST Timezone)
- **Timezone**: KST = UTC + 9 hours (`timezone(timedelta(hours=9))`)
- **Current time**: `today = datetime.now(KST)` (ALWAYS uses KST)
- **Monday calculation**: `monday = today - timedelta(days=today.weekday())`
  - `today.weekday()`: 0=Monday, 1=Tuesday, ..., 6=Sunday
  - Example: If today is Thursday (weekday=3), monday = today - 3 days
- **Sunday calculation**: `sunday = monday + timedelta(days=6)`
  - Always adds exactly 6 days to Monday
- **GitHub API UTC conversion** (critical for accurate commit counting):
  - Problem: GitHub API uses UTC timestamps, but we calculate week in KST
  - Solution: `monday_utc = monday.astimezone(timezone.utc)`
  - Format: ISO 8601 string `monday_utc.strftime('%Y-%m-%dT%H:%M:%SZ')`
  - Example: Monday Oct 27 00:00:00 KST → Sunday Oct 26 15:00:00 UTC
  - GraphQL query uses: `from: "2025-10-26T15:00:00Z", to: "2025-11-02T14:59:59Z"`
- **Display format**: MM/DD/YYYY (US format)
  - Format: `monday.strftime('%m/%d/%Y')` and `sunday.strftime('%m/%d/%Y')`
  - Example: "10/27/2025 — 11/02/2025"
- **Week ID format**: YYYY-Www (ISO week number)
  - Format: `f"{monday.year}-W{monday.isocalendar()[1]:02d}"`
  - Example: "2025-W44" (week 44 of 2025)

## 🛠️ Data Storage

### `data.json` Structure
```json
{
  "lastUpdated": "2025-10-27",           // YYYY-MM-DD format (KST timezone)
                                          // Updated by: slack_update.py when user submits
                                          // Used by: check_daily_update.py to prevent duplicate reminders
  "currentWeek": {
    "startDate": "2025-10-27",           // YYYY-MM-DD format (Monday of current week, KST)
    "endDate": "2025-11-02",             // YYYY-MM-DD format (Sunday of current week, KST)
                                          // Both auto-calculated by generate_svg.py or check_weekly_reset.py
    "metrics": {
      "commits": 120,                     // **AUTO-CALCULATED from GitHub API** (NEVER manually set)
                                          // Source: GitHub GraphQL API (all repos, private included)
                                          // Updated by: generate_svg.py (overwrites this field every time)
                                          // Calculation: Counts commits since Monday 00:00:00 KST (converted to UTC)
                                          // Scope: ALL repositories, not just current repo
                                          // Current value: 120 commits (Oct 27-28, 2025)
      "socialContent": {
        "instagram": 5,                  // Updated by: slack_update.py (additive)
        "tiktok": 3,                     // Slack input order: [0]=IG, [1]=TT, [2]=HT
        "hellotalk": 1                   // Total social posts = 5 + 3 + 1 = 9
      },
      "userSessions": 15,                // Updated by: slack_update.py (additive)
                                          // Slack input: position [3]
      "ctoMeetings": 2,                  // Updated by: slack_update.py (additive)
                                          // Slack input: position [4]
      "blogPosts": 1,                    // Updated by: slack_update.py (additive)
                                          // Slack input: position [5]
      "workouts": {
        "running": 3,                    // Updated by: slack_update.py (additive)
        "gym": 6                         // Slack input: [6]=running, [7]=gym
      }                                   // Total workouts = 3 + 6 = 9
    }
  },
  "weeklyHistory": [                     // Array of past weeks (max 12 weeks kept)
    {                                     // Most recent week at index 0
      "week": "2025-W43",                // ISO week format: YYYY-Www
      "startDate": "10/20/2025",        // MM/DD/YYYY format (Monday)
      "endDate": "10/26/2025",          // MM/DD/YYYY format (Sunday)
      "metrics": {                       // Snapshot of metrics at week end
        "commits": 83,                   // Historical commit count (Week 43: 83 commits, not 42 as in git)
        "socialContent": {               // **NOTE**: Actual git count for W43 = 42 commits
          "instagram": 0,                // This discrepancy indicates data.json was manually edited
          "tiktok": 0,
          "hellotalk": 3
        },
        "userSessions": 2,
        "ctoMeetings": 0,
        "blogPosts": 0,
        "workouts": {
          "running": 3,
          "gym": 4
        }
      }
    },
    {                                     // Week 42: Empty week (all zeros)
      "week": "2025-W42",
      "startDate": "10/13/2025",
      "endDate": "10/19/2025",
      "metrics": {
        "commits": 0,
        "socialContent": {"instagram": 0, "tiktok": 0, "hellotalk": 0},
        "userSessions": 0,
        "ctoMeetings": 0,
        "blogPosts": 0,
        "workouts": {"running": 0, "gym": 0}
      }
    }
  ]
}
```

### Update Strategy
- **Additive approach**: New values are ADDED to existing totals (slack_update.py line 91-102)
  - Example: If IG=5 and user inputs +3, new total = 8 (not replaced with 3)
  - Critical for daily incremental updates throughout the week
- **Single source of truth**: `data.json` is the authoritative source (except commits)
  - All scripts read from data.json (generate_svg.py, generate_slack_message.py, etc.)
  - Weekly history saved to data.json (check_weekly_reset.py)
- **Commits exception**: Commits are ALWAYS auto-calculated from GitHub GraphQL API
  - Source of truth: GitHub API (not data.json, not local git)
  - Scope: ALL repositories (private + public), not just current repo
  - data.json commits field is overwritten every time generate_svg.py runs
  - This ensures commit count is always accurate and reflects all your work
- **Automatic timestamp**: `lastUpdated` set to today (KST) when user inputs data
  - Format: `datetime.now(KST).strftime("%Y-%m-%d")`
  - Used by check_daily_update.py to prevent duplicate reminders
- **Weekly auto-reset** (Monday 7 AM KST):
  - check_weekly_reset.py runs before daily reminder
  - If new week detected:
    1. Save current week to weeklyHistory (insert at index 0)
    2. Reset all metrics to 0 (instagram, tiktok, hellotalk, userSessions, ctoMeetings, blogPosts, running, gym)
    3. Update startDate/endDate to new week Monday/Sunday
    4. commits field reset to 0, then immediately recalculated by generate_svg.py
  - History retention: Last 12 weeks only (older weeks discarded)

## 🔐 Secrets & Environment Variables

### Required GitHub Secrets
1. **SUMMARY_CARDS_TOKEN**: Personal Access Token (PAT) for GitHub API
   - Needs: `repo` scope for private repositories
   - Used by: `vn7n24fzkq/github-profile-summary-cards` action
   - Also used by: `generate_profile_card.py` for GraphQL queries

2. **SLACK_WEBHOOK_URL**: Slack Incoming Webhook URL
   - Used for: Daily reminders and confirmation messages
   - Format: `https://hooks.slack.com/services/...`

3. **GITHUB_TOKEN**: Automatically provided by GitHub Actions
   - Used for: Git operations (commit, push)
   - No manual setup required

## 📝 Development Guidelines

### ⚠️ CRITICAL: Working with Auto-Commit Workflows

**Problem**: GitHub Actions automatically commits every hour (profile cards) and on data.json changes (dashboard). This causes frequent remote-local divergence.

**Before Making ANY Changes**:
```bash
# ALWAYS pull first to avoid rebase conflicts
git pull --rebase

# OR set up automatic pull on commit
git config pull.rebase true  # Makes git pull use rebase by default
```

**Recommended Workflow**:
```bash
# 1. Pull latest changes
git pull --rebase

# 2. Make your changes
vim CLAUDE.md

# 3. Stage changes
git add CLAUDE.md

# 4. Pull again (in case Actions ran during your edits)
git pull --rebase

# 5. Commit
git commit -m "docs: update CLAUDE.md"

# 6. Pull one more time before push
git pull --rebase

# 7. Push
git push
```

**Common Scenarios**:

1. **Local commit + Remote auto-commit happened**:
   ```bash
   # You'll see: "Your branch is behind 'origin/main' by X commits"
   git pull --rebase  # Rebases your commit on top of remote
   git push
   ```

2. **Staged changes + Remote auto-commit**:
   ```bash
   # Error: "cannot pull with rebase: Your index contains uncommitted changes"
   git commit -m "your message"  # Commit first
   git pull --rebase              # Then rebase
   git push
   ```

3. **Merge conflict during rebase**:
   ```bash
   # Usually happens with dashboard/data.json or SVG files
   git status                     # Check conflicted files
   git checkout --theirs dashboard/weekly_dashboard.svg  # Accept remote version for auto-generated files
   git add dashboard/weekly_dashboard.svg
   git rebase --continue
   git push
   ```

**Files to NEVER Manually Edit** (auto-generated):
- `dashboard/weekly_dashboard.svg` - Generated by generate_svg.py
- `profile-summary-card-output/**/*.svg` - Generated by GitHub Actions
- `README.md` charts section - Auto-updated by update_readme_*.py
- Always accept remote version (`--theirs`) in conflicts

**Files Safe to Edit** (won't conflict):
- `CLAUDE.md`
- `HOWTOUSE.md`
- `SYSTEM_FLOW_EXPLAINED.md`
- Python scripts in `dashboard/`
- Workflow files in `.github/workflows/`

**Auto-Pull Setup** (Recommended):
```bash
# Configure git to always rebase on pull
git config pull.rebase true

# Configure globally for all repos
git config --global pull.rebase true

# Now `git pull` automatically does `git pull --rebase`
```

**Check Before Every Coding Session**:
```bash
# Quick status check
git status
git log --oneline -5  # See recent commits (yours + auto-commits)

# If behind, pull immediately
git pull --rebase
```

### When Modifying Profile Card
1. **Test locally first**: Run `python dashboard/generate_profile_card.py`
   - Expect API rate limit errors (403) without token
   - Check SVG structure and layout
2. **Size changes**: Update both `card_width`, `card_height` and SVG `<rect>`
3. **Pie chart size**: Modify `size` and `radius` in `generate_quadrant_pie_chart()`
4. **Position adjustments**: Use `translate(x, y)` for fine-tuning
5. **Commit and push**: GitHub Actions will regenerate with real data

### When Modifying Dashboard
1. **Test locally**: `python dashboard/generate_svg.py`
   - Uses data from `data.json`
   - Commit count will be 0 locally (needs git history)
2. **Layout changes**: Update `translate()` coordinates in SVG template
3. **Dimension changes**: Update both SVG canvas and background `<rect>`
4. **Card spacing**: 140px horizontal gap between cards (60, 200, 340)
5. **Auto-regeneration**: Workflow runs when `data.json` changes

### When Modifying Slack Integration
1. **Input format**: Always support backward compatibility
   - Parse 8 numbers → 7 numbers → 6 numbers → named format
2. **Message format**: Keep under Slack's 3000 character limit
3. **Confirmation message**: Show both "added" and "new totals"
4. **Error handling**: Default to 0 if parsing fails

### Color Palette
- **Background gradient**: `#ffffff` → `#f8fafc` / `#f1f5f9`
- **Card shadow**: `feDropShadow` with 8px blur, 10% opacity
- **Text colors**:
  - Primary: `#111827` / `#0f172a`
  - Secondary: `#1f2937`
  - Tertiary: `#6b7280` / `#64748b`
  - Muted: `#9ca3af`
- **Border**: `#e5e7eb` / `#e2e8f0`
- **Activity colors**: Blue, Green, Yellow, Red (from profile card)

## 🐛 Common Issues & Solutions

### Issue: Profile card shows dummy data (156 commits)
- **Cause**: GitHub API rate limit or no token
- **Solution**: Wait for GitHub Actions to run with `SUMMARY_CARDS_TOKEN`
- **Local testing**: Expected behavior, ignore local dummy data

### Issue: Pie chart not centered with legend
- **Cause**: Misaligned `translate()` coordinates
- **Solution**:
  - Pie chart: `translate(20, 20)` inside `translate(15, 55)` container
  - Legend: `translate(180, 42)` for vertical alignment
  - Legend height: 80px (4 items × 20px spacing)

### Issue: Dashboard has too much bottom padding
- **Cause**: SVG height too large for content
- **Solution**:
  - Last row ends at `y=200`, card height 100 = total 300
  - Add 30px padding = 330px total height
  - Update both `<svg height>` and `<rect height>`

### Issue: Slack reminder sent twice in one day
- **Cause**: `check_daily_update.py` not checking `lastUpdated`
- **Solution**: Ensure `lastUpdated` field matches today's date after user input

### Issue: Weekly totals not resetting
- **Behavior**: By design, manual reset required
- **Reason**: Allows flexible week boundaries and late updates
- **Reset method**: Manually edit `data.json` or script to reset on Monday

### Issue: Commits count is 0 in dashboard
- **Cause**: GitHub API call failed or token missing
- **Solution**:
  - Check `SUMMARY_CARDS_TOKEN` secret is set
  - Verify token has `repo` scope for private repositories
  - Check GitHub Actions logs for API errors
  - Run `python3 dashboard/get_weekly_commits.py` locally to test

## 🎨 Layout Specifications

### Profile Card (500x220px)
```
┌────────────────────────────────────────────────────────┐
│            GitHub Activity Overview (y=30)             │
├────────────────────┬───────────────────────────────────┤
│                    │                                   │
│    Pie Chart       │   Total Commits: 1,476            │
│    (144x144)       │   Joined: Aug 2024                │
│                    │   Daily avg: 3.3                  │
│    Legend          │                                   │
│    (4 items)       │                                   │
│                    │                                   │
└────────────────────┴───────────────────────────────────┘
     350px              150px
```

### Weekly Dashboard (520x330px)
```
┌──────────────────────────────────────────────────────┐
│     Moved the needle this week? 📈 (y=35)            │
│          10/27/2025 — 11/02/2025 (y=60)              │
├───────────┬───────────┬──────────────────────────────┤
│ Commits   │  Talks    │  Social Posts    (y=85)      │
│  120x100  │  120x100  │  120x100                     │
├───────────┼───────────┼──────────────────────────────┤
│  Coffee   │ Workouts  │  Blog Posts      (y=200)     │
│  120x100  │  120x100  │  120x100                     │
└───────────┴───────────┴──────────────────────────────┘
   60     200      340    (x positions)
```

## 📚 README Display

### Center Alignment
Both cards are displayed centered using HTML in README.md:
```html
<p align="center">
  <img src="https://raw.githubusercontent.com/Piesson/Piesson/main/profile-summary-card-output/default/0-profile-details.svg" alt="Profile Details">
</p>

<p align="center">
  <img src="https://raw.githubusercontent.com/Piesson/Piesson/main/dashboard/weekly_dashboard.svg" alt="Weekly Dashboard">
</p>
```

- **Desktop**: Centers cards in viewport
- **Mobile**: Scales automatically, maintains centering
- **Raw GitHub URLs**: Required for SVG rendering in README

## 🚀 Quick Commands

### Local Testing
```bash
# Profile card (expect 403 errors without token)
python dashboard/generate_profile_card.py

# Weekly dashboard (uses local data.json)
python dashboard/generate_svg.py

# Slack message preview
python dashboard/generate_slack_message.py morning
python dashboard/generate_slack_message.py evening

# Check if update needed
python dashboard/check_daily_update.py
echo $?  # 0 = send reminder, 1 = skip
```

### Manual Triggers
```bash
# Trigger profile card generation
gh workflow run profile-summary-cards.yml

# Trigger dashboard update
gh workflow run update_dashboard.yml

# Simulate Slack input
gh workflow run slack_response.yml -f metrics="1 0 0 2 0 0 1 1"
```

## 🔗 External Dependencies

### GitHub Actions
- `actions/checkout@v4` - Repository checkout
- `actions/setup-python@v4` - Python 3.11 setup
- `vn7n24fzkq/github-profile-summary-cards@release` - Standard profile cards

### Python Packages
- `requests` - HTTP requests for GraphQL and Slack webhooks
- Standard library: `json`, `datetime`, `subprocess`, `re`, `math`

### APIs
- **GitHub GraphQL API**: `https://api.github.com/graphql`
- **GitHub REST API**: `https://api.github.com/users/{username}/repos`
- **Slack Incoming Webhooks**: Custom webhook URL

## 📋 Maintenance Checklist

### Weekly
- [ ] Verify profile card shows accurate commit count
- [ ] Check dashboard reflects correct week dates
- [ ] Confirm Slack reminders sent at 7 AM and 7 PM KST
- [ ] Test Slack input → confirmation flow

### Monthly
- [ ] Review `weeklyHistory` data structure (currently unused)
- [ ] Check API rate limits (shouldn't be an issue with hourly runs)
- [ ] Verify token permissions still valid

### When Updating
- [ ] Test locally before committing
- [ ] Verify SVG renders correctly on GitHub
- [ ] Check mobile responsiveness
- [ ] Ensure backward compatibility for Slack input parsing
- [ ] Update this CLAUDE.md if workflow changes
