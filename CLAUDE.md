# CLAUDE.md

This file provides comprehensive guidance for Claude Code when working with the Piesson GitHub Profile Dashboard project.

## 🚨 CRITICAL RULES

### Git Commit Guidelines
- **NEVER use emojis in commit messages**
- Use clear, descriptive commit messages in English
- Follow conventional commit format: `type: description`
- Types: `feat`, `fix`, `refactor`, `chore`, `style`, `docs`

## 🎯 Project Overview

**Piesson GitHub Profile Dashboard** - Automated system displaying GitHub stats and weekly grind metrics on GitHub profile README.

### Two Main Systems:
1. **GitHub Profile Cards** - Shows commit stats, contributions, activity distribution
2. **Weekly Dashboard** - Tracks startup grind metrics (commits, user talks, social posts, etc.)

## 📁 Complete File Structure

```
Piesson/
├── dashboard/
│   ├── data.json                      # Current week metrics (updated by Slack)
│   ├── generate_svg.py                # Generates weekly dashboard SVG
│   ├── generate_profile_card.py       # Generates custom 4-quadrant profile card
│   ├── graphql_stats.py              # GitHub GraphQL API integration (2020-2025 data)
│   ├── generate_slack_message.py      # Daily Slack reminder generator
│   ├── slack_update.py               # Processes Slack input, updates data.json
│   ├── check_daily_update.py         # Checks if daily update received (prevents duplicate reminders)
│   └── weekly_dashboard.svg          # Generated dashboard (520x330px)
│
├── profile-summary-card-output/
│   └── default/
│       ├── 0-profile-details.svg     # Custom 4-quadrant card (500x220px)
│       ├── 1-repos-per-language.svg  # Generated by vn7n24fzkq action
│       ├── 2-most-commit-language.svg
│       ├── 3-stats.svg
│       └── 4-productive-time.svg
│
├── .github/workflows/
│   ├── profile-summary-cards.yml     # Hourly: GitHub stats cards generation
│   ├── update_dashboard.yml          # Daily reminders + dashboard updates
│   └── slack_response.yml            # Manual trigger for Slack updates
│
└── README.md                         # Displays both profile card and dashboard (centered)
```

## 🔄 System 1: GitHub Profile Cards

### Workflow: `profile-summary-cards.yml`
**Trigger**: Every hour (`0 * * * *`) + manual dispatch

**Process Flow**:
```
1. GitHub Actions runs hourly
   ↓
2. vn7n24fzkq/github-profile-summary-cards@release
   - Fetches accurate GitHub contribution data
   - Generates 5 standard SVG cards
   - Includes private repos with SUMMARY_CARDS_TOKEN
   ↓
3. generate_profile_card.py (custom Python script)
   - Calls graphql_stats.py to fetch 2020-2025 data
   - Generates custom 4-quadrant pie chart (144px diameter)
   - Shows: Commits (97%), Reviews (0%), PRs (0%), Issues (2%)
   - Displays: Total commits (1,476), Join date (Aug 2024), Daily avg (3.3)
   ↓
4. Git commit + push to main branch
   - Only commits if files changed
   - Commit message: "update: automated profile cards generation (original + custom 4-quadrant)"
```

### Technical Details

#### GraphQL API Integration (`graphql_stats.py`)
- **Multi-year fetching**: Loops through 2020-2025 (6 years)
- **Query per year**: `contributionsCollection(from, to)`
- **Data retrieved**:
  - `totalCommitContributions`
  - `totalPullRequestReviewContributions`
  - `totalPullRequestContributions`
  - `totalIssueContributions`
- **Requires**: `SUMMARY_CARDS_TOKEN` for private repos

#### Pie Chart Generation (`generate_profile_card.py`)
- **Size**: 144x144px (20% larger than original 120px)
- **Radius**: 54px
- **Position**: `translate(15, 55)` → Pie at `translate(20, 20)`, Legend at `translate(180, 42)`
- **Colors**:
  - Commits: `#3b82f6` (blue)
  - Reviews: `#10b981` (green)
  - PRs: `#f59e0b` (yellow)
  - Issues: `#ef4444` (red)
- **Data synchronization**: Single fetch, used by both pie chart and total commits display
- **Join date calculation**: `datetime(2024, 8, 1)` for accurate daily average

#### Layout Optimization
- **Card dimensions**: 500x220px
- **Vertical centering**: Pie chart centered with 4-item legend (80px total height)
- **Spacing**:
  - Main container: `translate(15, 55)`
  - Pie chart: Left-aligned for better visual balance
  - Divider: `x1="350"` separates left (chart+legend) from right (stats)

## 🔄 System 2: Weekly Dashboard

### Workflow: `update_dashboard.yml`
**Two Jobs**:

#### Job 1: `daily-reminder` (Schedule-based)
**Triggers**:
- 7 AM KST: `cron: '0 22 * * *'` (10 PM UTC)
- 7 PM KST: `cron: '0 10 * * *'` (10 AM UTC)

**Process Flow**:
```
1. GitHub Actions runs at scheduled time
   ↓
2. check_daily_update.py
   - Reads data.json → lastUpdated field
   - Compares with today's date
   - Exit code 0 = send reminder (no update today)
   - Exit code 1 = skip reminder (already updated)
   ↓
3. If reminder needed:
   generate_slack_message.py
   - Loads current metrics from data.json
   - Counts commits from git (this week only)
   - Generates formatted Slack message
   - Message type: "morning" or "evening" (different vibe)
   ↓
4. curl POST to SLACK_WEBHOOK_URL
   - Sends rich formatted message
   - Shows current week totals
   - Includes input format: `1 0 0 2 0 0 1 1`
```

#### Job 2: `update-dashboard` (Push-based)
**Trigger**: Push to `dashboard/data.json`

**Process Flow**:
```
1. Slack input processed → data.json updated
   ↓
2. GitHub Actions detects push to data.json
   ↓
3. generate_svg.py
   - Reads data.json → currentWeek.metrics
   - Calculates current week dates (Monday-Sunday)
   - Generates 520x330px SVG
   - 6 metric cards (120x100px each) in 3x2 grid
   ↓
4. Git commit + push
   - Commits weekly_dashboard.svg
   - Message: "update: automated dashboard generation"
```

### Slack Integration

#### Input Workflow (`slack_update.py`)
**Triggered by**: `slack_response.yml` (manual workflow_dispatch)

**Process Flow**:
```
1. User types in Slack: "1 0 0 2 0 0 1 1"
   ↓
2. Slack workflow triggers GitHub Actions
   - Input passed via workflow_dispatch parameter
   ↓
3. slack_update.py receives input
   - Parses 8 numbers: IG, TT, HT, UserTalks, CoffeeChats, BlogPosts, Running, Gym
   - Loads data.json
   - ADDS new values to existing totals (additive approach)
   - Updates lastUpdated to today
   - Saves data.json
   ↓
4. Sends confirmation message to Slack
   - Shows what was added today
   - Shows new totals
   - Format: "✅ Well done! Progress updated successfully!"
   ↓
5. Triggers update-dashboard job (via push to data.json)
```

#### Input Format Evolution
1. **Current (8 numbers)**: `1 0 0 2 0 0 1 1`
   - Order: Instagram, TikTok, HelloTalk, UserTalks, CoffeeChats, BlogPosts, Running, Gym
2. **Fallback (7 numbers)**: `3 2 1 10 2 1 5`
   - Splits workouts roughly (50/50)
3. **Legacy (6 numbers)**: `5 10 2 1 3 2`
   - Splits social posts into thirds
4. **Named format**: `Instagram: 3, TikTok: 2, ...`
   - Case-insensitive regex parsing

### Dashboard SVG Generation

#### Dimensions & Layout (`generate_svg.py`)
- **Canvas**: 520x330px (reduced from 440px to minimize bottom padding)
- **Background**: Linear gradient `#ffffff` → `#f8fafc`
- **Border radius**: 16px with `#e2e8f0` stroke
- **Title position**: `y="35"` (title), `y="60"` (date subtitle)
- **Grid**:
  - Row 1: `translate(60, 85)` - 3 cards spaced 140px apart
  - Row 2: `translate(60, 200)` - 3 cards spaced 140px apart
  - Card size: 120x100px with 12px border radius

#### Metric Cards (6 total)
1. **Code Commits** (🚀)
   - Calculated from git: `git rev-list --count --since <Monday> HEAD`
   - Shows: "Daily goal: 20 commits"
2. **User Talks** (💬)
   - From `data.json → userSessions`
   - Shows: "Daily goal: 1 talk"
3. **Social Posts** (📱)
   - Sum: `instagram + tiktok + hellotalk`
   - Shows breakdown: "IG:5 TT:3 HT:1"
4. **Coffee Chats** (☕)
   - From `data.json → ctoMeetings`
   - Shows: "Weekly goal: 2 chats"
5. **Workouts** (🏃)
   - Sum: `running + gym`
   - Shows breakdown: "Run:3 Gym:6"
6. **Blog Posts** (📝)
   - From `data.json → blogPosts`
   - Shows: "AI & Startup content"

#### Week Calculation
- Uses Python `datetime.datetime.now()`
- Monday = `today - timedelta(days=today.weekday())`
- Sunday = `monday + timedelta(days=6)`
- Format: MM/DD/YYYY (US format)

## 🛠️ Data Storage

### `data.json` Structure
```json
{
  "lastUpdated": "2025-10-27",           // YYYY-MM-DD format, updated when user submits
  "currentWeek": {
    "startDate": "2025-10-27",           // Auto-calculated Monday
    "endDate": "2025-11-02",             // Auto-calculated Sunday
    "metrics": {
      "commits": 18,                     // Auto-calculated from git (not in JSON source)
      "socialContent": {
        "instagram": 5,                  // Updated by Slack input
        "tiktok": 3,
        "hellotalk": 1
      },
      "userSessions": 15,                // Updated by Slack input
      "ctoMeetings": 2,                  // Updated by Slack input
      "blogPosts": 1,                    // Updated by Slack input
      "workouts": {
        "running": 3,                    // Updated by Slack input
        "gym": 6                         // Updated by Slack input
      }
    }
  },
  "weeklyHistory": [...]                 // Historical data (not currently used)
}
```

### Update Strategy
- **Additive approach**: New values are ADDED to existing totals
- **Single source of truth**: `data.json` is the only source (except commits from git)
- **Automatic timestamp**: `lastUpdated` set to today when user inputs data
- **No manual resets**: Weekly totals never auto-reset (manual management required)

## 🔐 Secrets & Environment Variables

### Required GitHub Secrets
1. **SUMMARY_CARDS_TOKEN**: Personal Access Token (PAT) for GitHub API
   - Needs: `repo` scope for private repositories
   - Used by: `vn7n24fzkq/github-profile-summary-cards` action
   - Also used by: `generate_profile_card.py` for GraphQL queries

2. **SLACK_WEBHOOK_URL**: Slack Incoming Webhook URL
   - Used for: Daily reminders and confirmation messages
   - Format: `https://hooks.slack.com/services/...`

3. **GITHUB_TOKEN**: Automatically provided by GitHub Actions
   - Used for: Git operations (commit, push)
   - No manual setup required

## 📝 Development Guidelines

### When Modifying Profile Card
1. **Test locally first**: Run `python dashboard/generate_profile_card.py`
   - Expect API rate limit errors (403) without token
   - Check SVG structure and layout
2. **Size changes**: Update both `card_width`, `card_height` and SVG `<rect>`
3. **Pie chart size**: Modify `size` and `radius` in `generate_quadrant_pie_chart()`
4. **Position adjustments**: Use `translate(x, y)` for fine-tuning
5. **Commit and push**: GitHub Actions will regenerate with real data

### When Modifying Dashboard
1. **Test locally**: `python dashboard/generate_svg.py`
   - Uses data from `data.json`
   - Commit count will be 0 locally (needs git history)
2. **Layout changes**: Update `translate()` coordinates in SVG template
3. **Dimension changes**: Update both SVG canvas and background `<rect>`
4. **Card spacing**: 140px horizontal gap between cards (60, 200, 340)
5. **Auto-regeneration**: Workflow runs when `data.json` changes

### When Modifying Slack Integration
1. **Input format**: Always support backward compatibility
   - Parse 8 numbers → 7 numbers → 6 numbers → named format
2. **Message format**: Keep under Slack's 3000 character limit
3. **Confirmation message**: Show both "added" and "new totals"
4. **Error handling**: Default to 0 if parsing fails

### Color Palette
- **Background gradient**: `#ffffff` → `#f8fafc` / `#f1f5f9`
- **Card shadow**: `feDropShadow` with 8px blur, 10% opacity
- **Text colors**:
  - Primary: `#111827` / `#0f172a`
  - Secondary: `#1f2937`
  - Tertiary: `#6b7280` / `#64748b`
  - Muted: `#9ca3af`
- **Border**: `#e5e7eb` / `#e2e8f0`
- **Activity colors**: Blue, Green, Yellow, Red (from profile card)

## 🐛 Common Issues & Solutions

### Issue: Profile card shows dummy data (156 commits)
- **Cause**: GitHub API rate limit or no token
- **Solution**: Wait for GitHub Actions to run with `SUMMARY_CARDS_TOKEN`
- **Local testing**: Expected behavior, ignore local dummy data

### Issue: Pie chart not centered with legend
- **Cause**: Misaligned `translate()` coordinates
- **Solution**:
  - Pie chart: `translate(20, 20)` inside `translate(15, 55)` container
  - Legend: `translate(180, 42)` for vertical alignment
  - Legend height: 80px (4 items × 20px spacing)

### Issue: Dashboard has too much bottom padding
- **Cause**: SVG height too large for content
- **Solution**:
  - Last row ends at `y=200`, card height 100 = total 300
  - Add 30px padding = 330px total height
  - Update both `<svg height>` and `<rect height>`

### Issue: Slack reminder sent twice in one day
- **Cause**: `check_daily_update.py` not checking `lastUpdated`
- **Solution**: Ensure `lastUpdated` field matches today's date after user input

### Issue: Weekly totals not resetting
- **Behavior**: By design, manual reset required
- **Reason**: Allows flexible week boundaries and late updates
- **Reset method**: Manually edit `data.json` or script to reset on Monday

### Issue: Commits count is 0 in dashboard
- **Cause**: Git history not available or week calculation error
- **Solution**: Check `generate_slack_message.py` → `get_git_commits_this_week()`
  - Uses `git rev-list --count --since <Monday> HEAD`
  - Requires local git repository with history

## 🎨 Layout Specifications

### Profile Card (500x220px)
```
┌────────────────────────────────────────────────────────┐
│            GitHub Activity Overview (y=30)             │
├────────────────────┬───────────────────────────────────┤
│                    │                                   │
│    Pie Chart       │   Total Commits: 1,476            │
│    (144x144)       │   Joined: Aug 2024                │
│                    │   Daily avg: 3.3                  │
│    Legend          │                                   │
│    (4 items)       │                                   │
│                    │                                   │
└────────────────────┴───────────────────────────────────┘
     350px              150px
```

### Weekly Dashboard (520x330px)
```
┌──────────────────────────────────────────────────────┐
│     Moved the needle this week? 📈 (y=35)            │
│          10/27/2025 — 11/02/2025 (y=60)              │
├───────────┬───────────┬──────────────────────────────┤
│ Commits   │  Talks    │  Social Posts    (y=85)      │
│  120x100  │  120x100  │  120x100                     │
├───────────┼───────────┼──────────────────────────────┤
│  Coffee   │ Workouts  │  Blog Posts      (y=200)     │
│  120x100  │  120x100  │  120x100                     │
└───────────┴───────────┴──────────────────────────────┘
   60     200      340    (x positions)
```

## 📚 README Display

### Center Alignment
Both cards are displayed centered using HTML in README.md:
```html
<p align="center">
  <img src="https://raw.githubusercontent.com/Piesson/Piesson/main/profile-summary-card-output/default/0-profile-details.svg" alt="Profile Details">
</p>

<p align="center">
  <img src="https://raw.githubusercontent.com/Piesson/Piesson/main/dashboard/weekly_dashboard.svg" alt="Weekly Dashboard">
</p>
```

- **Desktop**: Centers cards in viewport
- **Mobile**: Scales automatically, maintains centering
- **Raw GitHub URLs**: Required for SVG rendering in README

## 🚀 Quick Commands

### Local Testing
```bash
# Profile card (expect 403 errors without token)
python dashboard/generate_profile_card.py

# Weekly dashboard (uses local data.json)
python dashboard/generate_svg.py

# Slack message preview
python dashboard/generate_slack_message.py morning
python dashboard/generate_slack_message.py evening

# Check if update needed
python dashboard/check_daily_update.py
echo $?  # 0 = send reminder, 1 = skip
```

### Manual Triggers
```bash
# Trigger profile card generation
gh workflow run profile-summary-cards.yml

# Trigger dashboard update
gh workflow run update_dashboard.yml

# Simulate Slack input
gh workflow run slack_response.yml -f metrics="1 0 0 2 0 0 1 1"
```

## 🔗 External Dependencies

### GitHub Actions
- `actions/checkout@v4` - Repository checkout
- `actions/setup-python@v4` - Python 3.11 setup
- `vn7n24fzkq/github-profile-summary-cards@release` - Standard profile cards

### Python Packages
- `requests` - HTTP requests for GraphQL and Slack webhooks
- Standard library: `json`, `datetime`, `subprocess`, `re`, `math`

### APIs
- **GitHub GraphQL API**: `https://api.github.com/graphql`
- **GitHub REST API**: `https://api.github.com/users/{username}/repos`
- **Slack Incoming Webhooks**: Custom webhook URL

## 📋 Maintenance Checklist

### Weekly
- [ ] Verify profile card shows accurate commit count
- [ ] Check dashboard reflects correct week dates
- [ ] Confirm Slack reminders sent at 7 AM and 7 PM KST
- [ ] Test Slack input → confirmation flow

### Monthly
- [ ] Review `weeklyHistory` data structure (currently unused)
- [ ] Check API rate limits (shouldn't be an issue with hourly runs)
- [ ] Verify token permissions still valid

### When Updating
- [ ] Test locally before committing
- [ ] Verify SVG renders correctly on GitHub
- [ ] Check mobile responsiveness
- [ ] Ensure backward compatibility for Slack input parsing
- [ ] Update this CLAUDE.md if workflow changes
